<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dragon Eye Examiner - Live Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #0d0d0d; color: #e0e0e0; overflow-x: hidden; }
    body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; background: radial-gradient(circle at 50% 50%, rgba(100, 40, 0, 0.3), rgba(13, 13, 13, 0) 70%), linear-gradient(135deg, #0d0d0d 0%, #1a1a1a 100%); animation: pulse-background 20s infinite alternate; }
    @keyframes pulse-background { from { background-color: #0d0d0d; } to { background-color: #1a1a1a; } }
    #cgi-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
    .glass-card { background: rgba(26, 26, 26, 0.4); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 100, 0, 0.2); border-radius: 16px; animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
    .glass-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 100, 0, 0.3); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #0d0d0d; } ::-webkit-scrollbar-thumb { background-color: rgba(255, 100, 0, 0.4); border-radius: 10px; border: 2px solid #0d0d0d; }
    #risk-score, #risk-status { transition: color 0.5s ease, text-shadow 0.5s ease; }
    .status-safe { color: #4ade80; text-shadow: 0 0 10px #4ade80; }
    .status-warning { color: #f59e0b; text-shadow: 0 0 10px #f59e0b; }
    .status-danger { color: #ef4444; text-shadow: 0 0 15px #ef4444; }
    .thematic-title { font-family: 'Cinzel', serif; }
    .event-table-container { height: 250px; overflow-y: auto; }
    .event-table tr:hover { background-color: rgba(255, 255, 255, 0.05); }
    .event-table td, .event-table th { white-space: nowrap; padding: 0.75rem; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); z-index: 100; display: none; align-items: center; justify-content: center; }
    .modal-content { max-width: 90%; max-height: 90%; }
  </style>
</head>
<body class="antialiased">

  <canvas id="cgi-background"></canvas>

  <nav class="sticky top-0 z-10 glass-card mx-auto max-w-7xl mt-4 !rounded-full">
    <div class="px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <a href="/" class="flex items-center">
          <svg class="h-8 w-8 text-orange-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/><circle cx="12" cy="12" r="1.5" fill="#ef4444"/></svg>
          <div class="flex-shrink-0 text-white font-bold text-xl tracking-wider ml-3 thematic-title"><span class="text-orange-400">DRAGON</span> EYE</div>
        </a>
        <div class="hidden md:block ml-10 space-x-4">
            <a href="/copy_test" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Copy Test</a>
            <a href="/face_detection" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Face Detection</a>
            <a href="/risk" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Risk Scores</a>
        </div>
        <div class="flex items-center">
            <button id="shortcuts-toggle" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full transition-all duration-300 text-sm">Disable Shortcuts</button>
            <button id="lockdown-toggle" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-full transition-all duration-300 ml-2 text-sm">Enable Lockdown</button>
        </div>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <div class="px-4 py-6 sm:px-0 text-center">
      <h1 class="text-5xl font-bold text-white tracking-tight thematic-title" style="animation: fadeIn 1s 0.2s ease-out forwards; opacity: 0;">Live Proctoring Dashboard</h1>
      <p class="mt-4 text-lg text-gray-400" style="animation: fadeIn 1s 0.4s ease-out forwards; opacity: 0;">The Dragon's Gaze is upon this session.</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 px-4 py-6 sm:px-0">
        <div class="md:col-span-1 flex flex-col justify-center items-center glass-card p-6" style="animation-delay: 0.6s;">
            <h3 class="text-lg font-medium text-gray-300">Overall Risk Score</h3>
            <div id="risk-score" class="text-8xl font-bold mt-2 status-safe">0</div>
            <p id="risk-status" class="text-2xl mt-2 font-semibold status-safe">Safe</p>
        </div>
        <div class="md:col-span-2 glass-card p-6 flex flex-wrap justify-center items-center" style="animation-delay: 0.8s;">
            <h3 class="w-full text-center text-lg font-medium text-gray-300 mb-4">Export Event Logs</h3>
            <a href="/download/mouse_csv" class="bg-orange-600/80 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-full m-2 transition-all">Mouse CSV</a>
            <a href="/download/window_csv" class="bg-orange-600/80 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-full m-2 transition-all">Window CSV</a>
            <a href="/download/copy_csv" class="bg-orange-600/80 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-full m-2 transition-all">Copy CSV</a>
            <a href="/download/peripheral_csv" class="bg-orange-600/80 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-full m-2 transition-all">Peripheral CSV</a>
            <a href="/download/face_csv" class="bg-orange-600/80 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-full m-2 transition-all">Face CSV</a>
            <a href="/download/voice_csv" class="bg-orange-600/80 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-full m-2 transition-all">Voice CSV</a>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 px-4 py-6 sm:px-0">
      <div id="mouse-card" class="glass-card" style="animation-delay: 1s;"></div>
      <div id="window-card" class="glass-card" style="animation-delay: 1.1s;"></div>
      <div id="copy-card" class="glass-card" style="animation-delay: 1.2s;"></div>
      <div id="peripheral-card" class="glass-card" style="animation-delay: 1.3s;"></div>
      <div id="face-card" class="glass-card" style="animation-delay: 1.4s;"></div>
      <div id="voice-card" class="glass-card" style="animation-delay: 1.5s;"></div>
    </div>
  </main>

  <!-- Graph Modal -->
  <div id="graph-modal" class="modal-overlay">
    <div class="glass-card p-4 modal-content relative">
        <button id="close-modal-btn" class="absolute top-2 right-4 text-white text-3xl font-bold">&times;</button>
        <h3 id="modal-title" class="text-2xl text-center thematic-title text-orange-400 mb-4">Event Graph</h3>
        <img id="graph-image" src="" alt="Event Graph" class="mx-auto max-w-full max-h-[60vh] rounded-lg"/>
        <div class="text-center mt-4">
            <a id="download-graph-btn" href="" download="graph.png" class="bg-orange-600/80 hover:bg-orange-600 text-white font-bold py-2 px-6 rounded-full transition-all">Download Graph</a>
        </div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('cgi-background');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    let particlesArray;
    const mouse = { x: null, y: null, radius: (canvas.height/120) * (canvas.width/120) };
    window.addEventListener('mousemove', e => { mouse.x = e.x; mouse.y = e.y; });
    class Particle { constructor(x, y, dX, dY, s) { this.x=x; this.y=y; this.directionX=dX; this.directionY=dY; this.size=s; } draw() { ctx.beginPath(); ctx.arc(this.x,this.y,this.size,0,Math.PI*2); ctx.fillStyle='rgba(255, 100, 0, 0.5)'; ctx.fill(); } update() { if(this.x>canvas.width||this.x<0)this.directionX=-this.directionX; if(this.y>canvas.height||this.y<0)this.directionY=-this.directionY; let dx=mouse.x-this.x; let dy=mouse.y-this.y; let dist=Math.sqrt(dx*dx+dy*dy); if(dist<mouse.radius+this.size){if(mouse.x<this.x&&this.x<canvas.width-this.size*10)this.x+=5; if(mouse.x>this.x&&this.x>this.size*10)this.x-=5; if(mouse.y<this.y&&this.y<canvas.height-this.size*10)this.y+=5; if(mouse.y>this.y&&this.y>this.size*10)this.y-=5;} this.x+=this.directionX; this.y+=this.directionY; this.draw();}}
    function init() { particlesArray=[]; let num=(canvas.height*canvas.width)/9e3; for(let i=0;i<num;i++){let s=Math.random()*2+1; let x=Math.random()*(innerWidth-s*2-s*2)+s*2; let y=Math.random()*(innerHeight-s*2-s*2)+s*2; let dX=Math.random()*0.4-0.2; let dY=Math.random()*0.4-0.2; particlesArray.push(new Particle(x,y,dX,dY,s));}}
    function animate() { requestAnimationFrame(animate); ctx.clearRect(0,0,innerWidth,innerHeight); for(let i=0;i<particlesArray.length;i++)particlesArray[i].update(); connect();}
    function connect() { let opacity=1; for(let a=0;a<particlesArray.length;a++){for(let b=a;b<particlesArray.length;b++){let dist=((particlesArray[a].x-particlesArray[b].x)*(particlesArray[a].x-particlesArray[b].x))+((particlesArray[a].y-particlesArray[b].y)*(particlesArray[a].y-particlesArray[b].y)); if(dist<(canvas.width/7)*(canvas.height/7)){opacity=1-(dist/2e4); ctx.strokeStyle=`rgba(255, 150, 50, ${opacity})`; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(particlesArray[a].x,particlesArray[a].y); ctx.lineTo(particlesArray[b].x,particlesArray[b].y); ctx.stroke();}}}}
    window.addEventListener('resize', () => { canvas.width=innerWidth; canvas.height=innerHeight; mouse.radius=((canvas.height/120)*(canvas.height/120)); init();});
    window.addEventListener('mouseout', () => { mouse.x=undefined; mouse.y=undefined; });
    init(); animate();

    let showFlags = { mouse: false, window: false, copy: false, peripheral: false, face: false, voice: false };

    function createCard(cardId, title, headers) {
        const card = document.getElementById(cardId);
        if (!card) return;
        const graphType = cardId.replace('-card', '');
        card.innerHTML = `
            <div class="p-4 border-b border-white/10 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-white">${title}</h3>
                <button class="view-graph-btn text-sm text-orange-400 hover:text-orange-300" data-graph-type="${graphType}" data-graph-title="${title}">View Graph</button>
            </div>
            <div class="p-4">
                <div class="event-table-container">
                    <table class="w-full text-sm text-left event-table">
                        <thead>
                            <tr class="border-b border-gray-600">
                                ${headers.map(h => `<th class="py-2 px-4 font-semibold sticky top-0 bg-gray-800">${h}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody id="${cardId}-body"></tbody>
                    </table>
                </div>
            </div>
            <div id="${cardId}-toggle" class="p-2 text-center border-t border-white/10"></div>
        `;
    }

    function renderData(type, apiUrl, formatter) {
        const cardId = `${type}-card`;
        const showAll = showFlags[type];
        fetch(`${window.location.origin}${apiUrl}`)
            .then(response => response.ok ? response.json() : Promise.reject(response.status))
            .then(data => {
                const tableBody = document.getElementById(`${cardId}-body`);
                const toggleDiv = document.getElementById(`${cardId}-toggle`);
                if (!tableBody || !toggleDiv) return;

                tableBody.innerHTML = '';
                const displayData = showAll ? data.slice().reverse() : data.slice(-5).reverse();

                displayData.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = formatter(item);
                    row.className = "border-b border-gray-800";
                    tableBody.appendChild(row);
                });

                toggleDiv.innerHTML = '';
                if (data.length > 5) {
                    const btn = document.createElement('button');
                    btn.className = "text-orange-400 hover:text-orange-300 text-sm font-semibold";
                    btn.textContent = showAll ? "Show Less" : "Show All";
                    btn.onclick = () => { showFlags[type] = !showAll; updateTables(); };
                    toggleDiv.appendChild(btn);
                }
            })
            .catch(error => console.error(`Error fetching from ${apiUrl}:`, error));
    }

    function renderFaceData() {
        // This function is structured slightly differently because the event data is nested in the API response
        const showAll = showFlags.face;
        fetch(`${window.location.origin}/api/face_risk`)
            .then(response => response.ok ? response.json() : Promise.reject(response.status))
            .then(data => {
                const events = data.face_events || [];
                const tableBody = document.getElementById('face-card-body');
                const toggleDiv = document.getElementById('face-card-toggle');
                if (!tableBody || !toggleDiv) return;

                tableBody.innerHTML = '';
                const displayData = showAll ? events.slice().reverse() : events.slice(-5).reverse();

                displayData.forEach(item => {
                    const row = document.createElement('tr');
                    const date = new Date(item.timestamp * 1000).toLocaleTimeString();
                    let details = "";
                    if (item.event === "Multiple Faces Detected") details = "Faces: " + item.faces_detected;
                    else if (item.event.includes("Duration") || item.event.includes("Away")) details = "Duration: " + (item.duration ? item.duration.toFixed(2) : 'N/A') + " s";
                    else if (item.event.includes("Vertical")) details = "V-Diff: " + (item.vertical_diff ? item.vertical_diff.toFixed(2) : 'N/A');
                    row.innerHTML = `<td>${date}</td><td>${item.event}</td><td>${item.risk}</td><td>${details}</td>`;
                    row.className = "border-b border-gray-800";
                    tableBody.appendChild(row);
                });

                toggleDiv.innerHTML = '';
                if (events.length > 5) {
                    const btn = document.createElement('button');
                    btn.className = "text-orange-400 hover:text-orange-300 text-sm font-semibold";
                    btn.textContent = showAll ? "Show Less" : "Show All";
                    btn.onclick = () => { showFlags.face = !showAll; updateTables(); };
                    toggleDiv.appendChild(btn);
                }
            })
            .catch(error => console.error(`Error fetching from /api/face_risk:`, error));
    }

    function updateTables() {
        renderData('mouse', '/api/mouse_events', event => {
            const date = new Date(event.timestamp * 1000).toLocaleTimeString();
            let details = "";
            if (event.speed) details += `Speed: ${event.speed.toFixed(0)} px/s`;
            if (event.angle_diff) details += ` Angle: ${event.angle_diff.toFixed(0)}Â°`;
            return `<td>${date}</td><td>${event.event}</td><td>${details}</td>`;
        });
        renderData('window', '/api/window_events', event => {
            const date = new Date(event.timestamp * 1000).toLocaleTimeString();
            return `<td>${date}</td><td>${event.window}</td><td>${event.duration.toFixed(2)}s</td>`;
        });
        renderData('copy', '/api/copy_events', event => {
            const date = new Date(event.timestamp * 1000).toLocaleTimeString();
            return `<td>${date}</td><td>${event.event}</td><td>${event.word_count}</td><td>${event.content_preview}</td>`;
        });
        renderData('peripheral', '/api/peripheral_events', event => {
            const date = new Date(event.timestamp * 1000).toLocaleTimeString();
            return `<td>${date}</td><td>${event.device || event.Caption || "Unknown"}</td>`;
        });
        renderFaceData();
        renderData('voice', '/api/voice_events', item => {
            const date = new Date(item.timestamp * 1000).toLocaleTimeString();
            const audioPlayer = `<audio controls src="/${item.recording_file}" class="w-full h-10"></audio>`;
            return `<td>${date}</td><td>${item.event}</td><td>${item.duration.toFixed(2)}s</td><td>${audioPlayer}</td>`;
        });
        fetchRiskScore();
    }

    function fetchRiskScore() {
      fetch(`${window.location.origin}/api/risk`)
        .then(response => response.json())
        .then(data => {
          const scoreEl = document.getElementById('risk-score');
          const statusEl = document.getElementById('risk-status');

          scoreEl.textContent = data.aggregate.toFixed(0);
          statusEl.textContent = data.aggregate_status;

          statusEl.className = 'text-2xl mt-2 font-semibold';
          scoreEl.className = 'text-8xl font-bold mt-2';
          if (data.aggregate_status === 'Warning') {
              statusEl.classList.add('status-warning'); scoreEl.classList.add('status-warning');
          } else if (data.aggregate_status.includes('Kick')) {
              statusEl.classList.add('status-danger'); scoreEl.classList.add('status-danger');
          } else {
              statusEl.classList.add('status-safe'); scoreEl.classList.add('status-safe');
          }
          if (data.kickout) { window.location.href = "/kickout"; }
        });
    }

    // --- Modal Logic ---
    const modal = document.getElementById('graph-modal');
    const graphImage = document.getElementById('graph-image');
    const downloadBtn = document.getElementById('download-graph-btn');
    const modalTitle = document.getElementById('modal-title');

    function showGraphModal(eventType, title) {
        const graphUrl = `${window.location.origin}/graph/${eventType}`;
        graphImage.src = graphUrl;
        downloadBtn.href = graphUrl;
        downloadBtn.download = `${eventType}_graph.png`;
        modalTitle.textContent = `${title} Graph`;
        modal.style.display = 'flex';
    }

    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('view-graph-btn')) {
            const graphType = e.target.dataset.graphType;
            const graphTitle = e.target.dataset.graphTitle;
            showGraphModal(graphType, graphTitle);
        }
    });

    document.getElementById('close-modal-btn').addEventListener('click', () => {
        modal.style.display = 'none';
    });

    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        createCard('mouse-card', 'Mouse Events', ['Time', 'Event', 'Details']);
        createCard('window-card', 'Window Events', ['Time', 'Window', 'Duration']);
        createCard('copy-card', 'Copy Events', ['Time', 'Event', 'Words', 'Preview']);
        createCard('peripheral-card', 'Peripheral Events', ['Time', 'Device']);
        createCard('face-card', 'Face Detection Events', ['Time', 'Event', 'Risk', 'Details']);
        createCard('voice-card', 'Voice Detection Events', ['Time', 'Event', 'Duration', 'Recording']);
        updateTables();
        setInterval(updateTables, 2000);
    });

    document.getElementById('lockdown-toggle').addEventListener('click', function() {
      const state = this.textContent.includes("Enable") ? 'on' : 'off';
      fetch(`${window.location.origin}/api/network_lockdown?state=${state}`)
        .then(() => { this.textContent = (state === 'on') ? "Disable Lockdown" : "Enable Lockdown"; });
    });

    document.getElementById('shortcuts-toggle').addEventListener('click', function() {
      const state = this.textContent.includes("Disable") ? "disable" : "enable";
      fetch(`${window.location.origin}/api/shortcuts?state=${state}`)
        .then(() => { this.textContent = state === "disable" ? "Enable Shortcuts" : "Disable Shortcuts"; });
    });
  </script>
</body>
</html>
